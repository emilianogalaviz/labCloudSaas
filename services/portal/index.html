<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>LabCloud SaaS - Gesti√≥n de Laboratorios</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #f0f2f5; margin: 0; }
        .login-container { display: flex; justify-content: center; align-items: center; height: 100vh; }
        .card { background: white; padding: 40px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); width: 350px; text-align: center; }
        input, select, textarea { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; }
        button { width: 100%; padding: 12px; background-color: #0066cc; color: white; border: none; border-radius: 5px; font-weight: bold; cursor: pointer; transition: 0.3s; }
        button:hover { background-color: #0052a3; }
        .dashboard-container { max-width: 1000px; margin: 0 auto; padding: 20px; display: none; }
        .navbar { display: flex; justify-content: space-between; align-items: center; background: white; padding: 15px 30px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .lab-badge { background: #e3f2fd; color: #0d47a1; padding: 5px 15px; border-radius: 20px; font-weight: bold; font-size: 0.9em; border: 1px solid #bbdefb; }
        .grid { display: grid; grid-template-columns: 1fr 2fr; gap: 20px; }
        .panel { background: white; padding: 25px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        h2 { margin-top: 0; color: #333; }
        label { display: block; text-align: left; font-weight: bold; margin-top: 10px; color: #555; }
        .success-msg { background: #d4edda; color: #155724; padding: 10px; border-radius: 5px; display: none; margin-top: 10px; }
        .error-msg { background: #f8d7da; color: #721c24; padding: 10px; border-radius: 5px; display: none; margin-top: 10px; }
    </style>

    <script src="https://sdk.amazonaws.com/js/aws-sdk-2.1363.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/amazon-cognito-identity-js@6.3.3/dist/amazon-cognito-identity.min.js"></script>
    </head>
<body>

    <div id="login-view" class="login-container">
        <div class="card">
            <h2 style="color:#0066cc;">LabCloud SaaS</h2>
            <p style="color:#666;">Plataforma Multi-Tenant</p>
            <input type="email" id="email" placeholder="Correo Administrativo">
            <input type="password" id="password" placeholder="Contrase√±a">
            <button onclick="login()">Ingresar al Tenant</button>
            <p id="login-error" class="error-msg" style="display:none;"></p>
        </div>
    </div>

    <div id="dashboard-view" class="dashboard-container">
        <div class="navbar">
            <div>
                <h3 style="margin:0;">Panel de Administraci√≥n</h3>
                <small id="user-email-display" style="color:#666;">...</small>
            </div>
            <div style="text-align: right;">
                <div class="lab-badge" id="tenant-badge">Cargando Tenant...</div>
                <a href="#" onclick="logout()" style="font-size:0.8em; color:red; text-decoration:none; margin-top:5px; display:block;">Cerrar Sesi√≥n</a>
            </div>
        </div>

        <div class="grid">
            <div class="panel">
                <h3>Registrar Paciente</h3>
                <p style="font-size:0.9em; color:#666;">Los datos se guardar√°n en tu esquema aislado.</p>
                <label>Nombre del Paciente:</label>
                <input type="text" id="p_name" placeholder="Ej: Juan P√©rez">
                <label>Tipo de Prueba:</label>
                <select id="p_test">
                    <option value="Sangu√≠nea">An√°lisis Sangu√≠neo</option>
                    <option value="COVID-19">Prueba COVID-19</option>
                    <option value="Orina">General de Orina</option>
                </select>
                <label>Resultados (JSON/Texto):</label>
                <textarea id="p_result" rows="3" placeholder='{"glucosa": 95}'></textarea>
                <button onclick="registrarPaciente()" style="margin-top:15px;">Guardar en Base de Datos</button>
                <div id="api-msg" class="success-msg"></div>
            </div>
            <div class="panel">
                <h3>Buscar en Base de Datos</h3>
                <div style="display:flex; gap:10px;">
                    <input type="text" placeholder="ID o Nombre..." style="margin:0;">
                    <button style="width:auto;">Buscar</button>
                </div>
                <br>
                <div style="background:#f9f9f9; padding:15px; border-radius:5px; border:1px dashed #ccc; height:200px; color:#888; display:flex; align-items:center; justify-content:center;">
                    Resultados del esquema <b id="schema-display" style="margin-left:5px;">...</b> aparecer√°n aqu√≠.
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        // ‚ö†Ô∏è PEGA TUS DATOS AQU√ç OTRA VEZ
        // ==========================================
        const API_URL = "https://msu80ions6.execute-api.us-east-2.amazonaws.com"; 
        const POOL_DATA = {
            UserPoolId: 'us-east-2_MtxCxYovb', 
            ClientId: '2helbqvf2cl0fitme2sh7t2ugl' 
        };

        var userPool = new AmazonCognitoIdentity.CognitoUserPool(POOL_DATA);
        var currentTenantId = null;

        function login() {
            var email = document.getElementById('email').value;
            var password = document.getElementById('password').value;
            
            var authData = { Username: email, Password: password };
            var authDetails = new AmazonCognitoIdentity.AuthenticationDetails(authData);
            var userData = { Username: email, Pool: userPool };
            var cognitoUser = new AmazonCognitoIdentity.CognitoUser(userData);

            document.getElementById('login-error').style.display = 'none';

            cognitoUser.authenticateUser(authDetails, {
                onSuccess: function(result) {
                    var payload = result.getIdToken().payload;
                    currentTenantId = payload['custom:tenant_id'];
                    var emailUser = payload['email'];
                    
                    if(!currentTenantId) {
                        alert("Error: Usuario sin Tenant ID.");
                        return;
                    }
                    loadDashboard(emailUser, currentTenantId);
                },
                onFailure: function(err) {
                    var errorDiv = document.getElementById('login-error');
                    errorDiv.innerText = err.message || JSON.stringify(err);
                    errorDiv.style.display = 'block';
                },
                newPasswordRequired: function(userAttributes, requiredAttributes) {
                    // Cognito a veces pide cambio de contrase√±a al primer login
                    // Para esta demo, lo forzamos con la misma contrase√±a (truco r√°pido)
                    cognitoUser.completeNewPasswordChallenge(password, {}, {
                        onSuccess: function(result) { login(); },
                        onFailure: function(err) { alert("Error pass: " + err.message); }
                    });
                }
            });
        }

        function loadDashboard(email, tenantId) {
            document.getElementById('login-view').style.display = 'none';
            document.getElementById('dashboard-view').style.display = 'block';
            document.getElementById('user-email-display').innerText = email;
            document.getElementById('tenant-badge').innerText = "üè¢ " + tenantId.toUpperCase();
            document.getElementById('schema-display').innerText = tenantId;
        }

        async function registrarPaciente() {
            const name = document.getElementById('p_name').value;
            const test = document.getElementById('p_test').value;
            const result = document.getElementById('p_result').value;
            const msgDiv = document.getElementById('api-msg');

            msgDiv.style.display = 'block';
            msgDiv.style.background = "#e2e6ea";
            msgDiv.style.color = "#333";
            msgDiv.innerText = "Enviando...";

            try {
                const response = await fetch(`${API_URL}/ingest`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        tenant_id: currentTenantId,
                        patient_name: name,
                        test_type: test,
                        result_data: result,
                        timestamp: new Date().toISOString()
                    })
                });
                const data = await response.json();
                if (response.ok) {
                    msgDiv.style.background = "#d4edda";
                    msgDiv.style.color = "#155724";
                    msgDiv.innerText = "‚úÖ Guardado en esquema: " + currentTenantId;
                } else { throw new Error(data.body); }
            } catch (error) {
                msgDiv.style.background = "#f8d7da";
                msgDiv.style.color = "#721c24";
                msgDiv.innerText = "Error: " + error.message;
            }
        }

        function logout() { location.reload(); }
    </script>
</body>
</html>